<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HEALPix to Mesh Converter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Monaco', 'Courier New', monospace;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 40px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: #4ecdc4;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #888;
      margin-bottom: 30px;
    }

    .section {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section h2 {
      color: #4ecdc4;
      font-size: 16px;
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
    }

    select, input[type="number"], button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 4px;
      color: #e0e0e0;
      font-family: inherit;
    }

    button {
      background: #4ecdc4;
      color: #1a1a1a;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #5eddd4;
    }

    button:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
    }

    .output {
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 15px;
      font-size: 12px;
      line-height: 1.6;
      min-height: 100px;
      white-space: pre-wrap;
      color: #4ecdc4;
    }

    .progress {
      margin-top: 10px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>HEALPix to Mesh Converter</h1>
    <p class="subtitle">Generate proper triangle meshes from HEALPix elevation data</p>

    <div class="section">
      <h2>Input Settings</h2>

      <label for="source">Source Data:</label>
      <select id="source">
        <option value="./earthtoposources/sur_healpix_nside128.bin">Surface Elevation (sur_healpix_nside128.bin)</option>
        <option value="./earthtoposources/bed_healpix_nside128.bin">Bedrock Elevation (bed_healpix_nside128.bin)</option>
      </select>

      <label for="subdivisions">Mesh Subdivisions (detail level):</label>
      <input type="number" id="subdivisions" min="16" max="128" step="8" value="64">
      <small style="color: #666; display: block; margin-top: -10px; margin-bottom: 15px;">
        Higher = more detail, larger file. 32=low, 64=medium, 96=high
      </small>

      <button id="convertBtn">Convert to Mesh</button>
    </div>

    <div class="section">
      <h2>Output</h2>
      <div id="output" class="output">Click "Convert to Mesh" to start...</div>
      <div id="progress" class="progress"></div>
      <button id="downloadBtn" style="display: none;">Download Mesh File</button>
    </div>
  </div>

  <script type="module">
    import { createMeshFromHealpix, exportMeshBinary } from './src/healpixToMesh.js';

    const sourceSelect = document.getElementById('source');
    const subdivisionsInput = document.getElementById('subdivisions');
    const convertBtn = document.getElementById('convertBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const output = document.getElementById('output');
    const progress = document.getElementById('progress');

    let meshBuffer = null;
    let meshName = '';

    convertBtn.addEventListener('click', async () => {
      try {
        convertBtn.disabled = true;
        output.textContent = 'Loading HEALPix data...';
        progress.textContent = '';
        downloadBtn.style.display = 'none';

        // Load HEALPix data
        const url = sourceSelect.value;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to load ${url}`);

        const buffer = await response.arrayBuffer();
        const healpixData = new Float32Array(buffer);

        const npix = healpixData.length;
        const nside = Math.sqrt(npix / 12);

        output.textContent = `Loaded ${npix.toLocaleString()} pixels (nside=${nside})\\n`;
        output.textContent += `Elevation range: ${Math.min(...healpixData).toFixed(1)} to ${Math.max(...healpixData).toFixed(1)} m\\n\\n`;
        output.textContent += 'Creating mesh...';

        // Create mesh
        await new Promise(resolve => setTimeout(resolve, 100)); // Let UI update

        const subdivisions = parseInt(subdivisionsInput.value);
        const meshData = createMeshFromHealpix(healpixData, nside, subdivisions);

        output.textContent += '\\nDone!\\n\\n';
        output.textContent += `Vertices: ${meshData.numVertices.toLocaleString()}\\n`;
        output.textContent += `Triangles: ${meshData.numTriangles.toLocaleString()}\\n`;

        // Export to binary
        output.textContent += '\\nExporting to binary format...';
        meshBuffer = exportMeshBinary(meshData);

        const sizeMB = (meshBuffer.byteLength / 1024 / 1024).toFixed(2);
        const sizeKB = (meshBuffer.byteLength / 1024).toFixed(1);

        output.textContent += '\\nDone!\\n\\n';
        output.textContent += `File size: ${sizeKB} KB (${sizeMB} MB)\\n`;
        output.textContent += `\\nReady to download!`;

        // Prepare download
        const sourceName = url.includes('sur_') ? 'sur' : 'bed';
        meshName = `${sourceName}_mesh_sub${subdivisions}.bin`;

        downloadBtn.style.display = 'block';
        convertBtn.disabled = false;

      } catch (error) {
        output.textContent = `Error: ${error.message}`;
        console.error(error);
        convertBtn.disabled = false;
      }
    });

    downloadBtn.addEventListener('click', () => {
      if (!meshBuffer) return;

      const blob = new Blob([meshBuffer], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = meshName;
      a.click();

      URL.revokeObjectURL(url);

      progress.textContent = `Downloaded: ${meshName}`;
    });
  </script>
</body>
</html>
